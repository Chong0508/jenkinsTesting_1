// Jenkins Declarative Pipeline for CMS Spring Boot Application

pipeline {
    // 1. Environment: Use any available Jenkins node/executor
    agent any

    stages {
        // Stage 1: Manual Docker Run (from your previous attempt)
        // NOTE: This runs the build command on the Jenkins host, but inside a temporary container.
        stage('Initial Docker Build') {
            steps {
                // The 'sh' step must be used to run your build inside a container manually
                sh 'docker run --rm -v $(pwd):/app -w /app maven:3-jdk-11 mvn clean install -DskipTests=true'
            }
        }

        // Stage 2: Build the Java application and run Unit Tests
        stage('Build & Unit Test') {
            steps {
                echo '1. Compiling source code and running all unit tests (mvn test)...'
                // 'clean install' packages the .jar, and '-DskipTests=false' ensures tests run
                // NOTE: This assumes the Jenkins executor itself has Maven installed, 
                //       or the 'agent' is configured for Maven.
                sh 'mvn clean install -DskipTests=false -B'
            }
        }

        // Stage 3: Deploy / Start Services for Integration Tests (Docker Compose)
        stage('Setup Integration Environment') {
            steps {
                echo '2. Starting MySQL and Spring Boot API containers for integration testing...'
                // Start the database (mysql-db) and API (cms-api) services in detached mode
                sh 'docker-compose up -d --build cms-api mysql-db'
                // Waiting for service availability
                sh 'sleep 30' 
            }
        }

        // Stage 4: Run Full Integration/API Tests
        stage('Integration Tests') {
            // Only proceed if the previous unit tests passed successfully
            when {
                expression { return currentBuild.result == 'SUCCESS' }
            }
            steps {
                echo '3. Running API/Integration Tests (using Maven Failsafe)...'
                // Executes tests designed to hit the live API endpoints
                sh 'mvn failsafe:integration-test -DskipTests=false -B'
            }
        }
    } // <-- CORRECT CLOSING BRACE for the main 'stages' block

    // Post-Build Actions: Cleanup and Reporting
    post {
        always {
            echo '4. Cleaning up Docker containers and publishing reports...'
            // Stop and remove the containers launched in Stage 3
            sh 'docker-compose down'
            
            // Publish test reports to Jenkins UI
            junit '**/target/surefire-reports/TEST-*.xml'
            
            // Clean workspace to free up disk space
            cleanWs()
        }
        success {
            echo 'Pipeline Success! Tests passed and Report is published.'
        }
        failure {
            echo 'Pipeline FAILED. Check console output and Test Results for errors.'
        }
    }
}