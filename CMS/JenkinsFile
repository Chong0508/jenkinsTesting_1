stage('Build & Unit Test') {
    steps {
        dir('CMS') {
            echo 'Setting Maven Wrapper executable...'
            sh 'chmod +x mvnw'
            
            echo 'Building project...'
            sh './mvnw clean install -DskipTests=true'
            
            echo 'Running ONLY unit tests (excluding integration tests)...'
            sh './mvnw test -Dtest=!*IntegrationTest,!*ApplicationTests'
        }
    }
    post {
        always {
            junit 'CMS/target/surefire-reports/*.xml'
        }
    }
}

stage('Setup Integration Environment') {
    steps {
        echo 'Starting MySQL database...'
        sh 'docker-compose -f CMS/docker-compose.yml up -d mysql'
        
        echo 'Waiting for MySQL to be ready...'
        sh '''
            timeout 60 sh -c 'until docker-compose -f CMS/docker-compose.yml exec -T mysql mysqladmin ping -h localhost --silent; do
                echo "Waiting for MySQL..."
                sleep 2
            done'
        '''
    }
}

stage('Integration Tests') {
    steps {
        dir('CMS') {
            echo 'Running integration tests...'
            sh './mvnw test -Dtest=*ApplicationTests,*IntegrationTest'
        }
    }
    post {
        always {
            junit 'CMS/target/surefire-reports/*.xml'
        }
    }
}