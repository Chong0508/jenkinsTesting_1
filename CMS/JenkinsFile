pipeline {
    agent any

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Verify Project Structure') {
            steps {
                echo 'Checking CMS/pom.xml...'
                sh '[ -f CMS/pom.xml ] || echo "pom.xml not found!"'
            }
        }

        stage('Initial Docker Build') {
            steps {
                echo 'Running Maven inside Docker...'

                // Option 1: Use -f to explicitly point to pom.xml
                sh '''
                    docker run -u 0 --rm \
                    -v $PWD:/app \
                    -w /app \
                    maven:3-jdk-11 \
                    mvn -f CMS/pom.xml clean install -DskipTests=true
                '''

                // Option 2: Mount CMS directly (uncomment if preferred)
                // sh '''
                //     docker run -u 0 --rm \
                //     -v $PWD/CMS:/app \
                //     -w /app \
                //     maven:3-jdk-11 \
                //     mvn clean install -DskipTests=true
                // '''
            }
        }

        stage('Build & Unit Test') {
            steps {
                echo 'Build & Unit Test stage will run if Initial Docker Build succeeds.'
                // Add your actual unit test commands here
            }
        }
    }

    post {
        always {
            echo 'Cleaning environment...'
            sh 'docker-compose -f CMS/docker-compose.yml down || true'
            cleanWs()
        }
    }
}
